<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.checkin.mapper.CheckinCheckoutMapper">

    <select id="listCheckinCheckout" resultType="com.checkin.dto.response.CheckinCheckoutResponse">

        SELECT
        cc.employee_code,
        u.fullname,
        d.name AS department_name,
        u2.name AS unit_name,
        cc.date,
        MIN(cc.checkin_time) as checkin_time,
        MAX(cc.checkout_time) as checkout_time,
        (MAX(cc.checkout_time) - MIN(cc.checkin_time))::time as working_time,
        (MIN(cc.checkin_time) - ws.start_time)::time as late_time,
        (ws.end_time -MAX(cc.checkout_time))::time as early_out_time
        FROM
        checkin_checkout cc
        JOIN
        users u ON cc.employee_code = u.employee_code
        JOIN
        department d ON u.department_code = d.code
        JOIN
        unit u2 ON u.unit_code = u2.code
        JOIN
        status s ON cc.status = s.id
        JOIN
        work_schedule ws ON EXTRACT(DOW FROM cc.date) + 1 = ws.day_of_week

        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                LOWER(u.fullname) LIKE CONCAT('%', LOWER(#{keyword}), '%')
                OR u.email LIKE CONCAT('%', #{keyword}, '%')
                OR u.employee_code LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="departmentCode != null and departmentCode != ''">
                AND u.department_code = #{departmentCode}
            </if>
            <if test="date != null">
                AND cc.date = #{date}
            </if>
            <if test="statusId != null and statusId != ''">
                AND cc.status = #{statusId}
            </if>
            <if test="unitCode != null and unitCode != ''">
                AND u.unit_code = #{unitCode}
            </if>
            <if test="month != null">
                AND TO_CHAR(cc.date, 'MM/YYYY') = TO_CHAR(#{month}::timestamp, 'MM/YYYY')
            </if>
        </where>
        GROUP BY
        cc.employee_code, u.fullname, department_name, unit_name, cc.date, s.name, ws.start_time, ws.end_time
        order by cc."date" desc,checkout_time desc, checkin_time desc
        <if test="limit > 0">
            OFFSET (#{page} - 1) * #{limit} FETCH NEXT #{limit} ROWS ONLY
        </if>
    </select>
    <select id="listCheckinCheckoutDetail" resultType="com.checkin.dto.response.CheckinCheckoutResponse">


        SELECT
            u.employee_code,
            g.name AS gender,
            u.fullname,
            j.name AS job_title_name,
            d.name AS department_name,
            un.name AS unit_name,
            cc.date,
            cc.checkin_time,
            cc.checkout_time,
            cc.working_time,
            cc.late_time,
            cc.early_out_time,
            s.name AS status_name
        FROM
            users u
                JOIN
            gender g ON u.gender_id = g.id
                LEFT JOIN
            job_title j ON u.job_title_code = j.code
                LEFT JOIN
            department d ON u.department_code = d.code
                LEFT JOIN
            unit un ON u.unit_code = un.code
                LEFT JOIN
            checkin_checkout cc ON u.employee_code = cc.employee_code
                LEFT JOIN
            status s ON cc.status = s.id
        WHERE
            u.employee_code = #{employeeCode} and cc.date = #{date}
    </select>
    <select id="totalCheckin" resultType="com.checkin.dto.response.CheckinCheckoutResponse">
        SELECT
        cc.employee_code,
        u.fullname,
        d.name AS department_name,
        u2.name AS unit_name,
        cc.date,
        MIN(cc.checkin_time) as checkin_time,
        MAX(cc.checkout_time) as checkout_time,
        (MAX(cc.checkout_time) - MIN(cc.checkin_time))::time as working_time,
        (MIN(cc.checkin_time) - ws.start_time)::time as late_time,
        (ws.end_time -MAX(cc.checkout_time))::time as early_out_time
        FROM
        checkin_checkout cc
        JOIN
        users u ON cc.employee_code = u.employee_code
        JOIN
        department d ON u.department_code = d.code
        JOIN
        unit u2 ON u.unit_code = u2.code
        JOIN
        status s ON cc.status = s.id
        JOIN
        work_schedule ws ON EXTRACT(DOW FROM cc.date) + 1 = ws.day_of_week

        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                LOWER(u.fullname) LIKE CONCAT('%', LOWER(#{keyword}), '%')
                OR u.email LIKE CONCAT('%', #{keyword}, '%')
                OR u.employee_code LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="departmentCode != null and departmentCode != ''">
                AND u.department_code = #{departmentCode}
            </if>
            <if test="date != null">
                AND cc.date = #{date}
            </if>
            <if test="statusId != null and statusId != ''">
                AND cc.status = #{statusId}
            </if>
            <if test="unitCode != null and unitCode != ''">
                AND u.unit_code = #{unitCode}
            </if>
            <if test="month != null">
                AND TO_CHAR(cc.date, 'MM/YYYY') = TO_CHAR(#{month}::timestamp, 'MM/YYYY')
            </if>
        </where>
        GROUP BY
        cc.employee_code, u.fullname, d.name, u2.name, cc.date, s.name, ws.start_time, ws.end_time
    </select>
</mapper>